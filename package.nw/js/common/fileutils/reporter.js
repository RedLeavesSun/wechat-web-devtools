"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const request=require("request"),utils_1=require("./utils"),URL="https://cube.weixinbridge.com/cube/report/reportbizdata?f=json",UPLOAD_INTERVAL=2e4;let _customRequest,_baseReportData={};function initReport(t,e){_baseReportData=Object.assign(Object.assign({},_baseReportData),t),"function"==typeof e&&(_customRequest=e)}exports.initReport=initReport;class Reporter{constructor(t,e={},r=!0){this._enabled=!0,this._timeStartMap={},this.stop=()=>{this.reset(),clearInterval(this._timer)},this.reset=()=>{this._reportQueues=[]},this.upload=async()=>{if(!this._reportQueues||0===this._reportQueues.length)return;const t=`report_items=${JSON.stringify(this._reportQueues)}`;try{(_customRequest||request)({url:URL,method:"POST",body:t},(t=>{t&&this._logger.error("report error: ",t)}))}catch(t){this._logger.error("report error: ",t)}finally{this.reset()}},this.report=async(t={})=>{const e=Object.assign(Object.assign({os_type:process.platform,time:Math.round(Date.now()/1e3),duration:this.timeEnd(t.action)},_baseReportData),t);if(!this._enabled||utils_1.isTest||!t.action)return;const r=[t.action];t.actionDetail&&r.push(t.actionDetail),this._logger.warn(`${r.join("-")} duration`,e.duration),this._reportQueues.push(e)},this._reportQueues=[],this._logger=t,_baseReportData=Object.assign(Object.assign({},_baseReportData),e),this._enabled=r,process.on("uncaughtException",(async()=>{try{await this.upload()}catch(t){this._logger.error("upload log error: ",t)}finally{this.stop()}})).on("beforeExit",(async()=>{try{await this.upload()}catch(t){console.error(t)}finally{this.stop()}})),this._timer=setInterval((()=>{this._timer&&this.upload()}),2e4)}timeStart(t){this._timeStartMap[t]=Date.now(),this._logger.warn(`${t} start`)}timeEnd(t){return t&&this._timeStartMap[t]?Date.now()-this._timeStartMap[t]:0}}exports.Reporter=Reporter;