"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),path=require("path"),events=require("events"),child_process=require("child_process"),glob=require("glob"),fse=require("fs-extra"),_=require("../utils"),logger_1=require("../logger"),reporter_1=require("../reporter"),filecacheutils_1=require("./filecacheutils"),config_1=require("./config"),cache_1=require("./cache"),fwhelper_1=require("./fwhelper"),anymatch=require("vscode-anymatch"),chokidar=require("chokidar"),manifest=require("../manifest.json"),{FileWatcher:FileWatcher}=require("../@fw/index.js");let _id=0;class FileUtils extends events.EventEmitter{constructor(e,t={}){super(),this._ready=!1,this._parentWatcher=null,this.id=_id++,this._info={},this._all=(e,t,i)=>{t&&(t=this.formatWindowsSharePath(t,!1),t=this._transferPathToRealPath(e,t)),this._cache.deleteFileData(t);const s={},r=path.posix.relative(this.dirPath,t);if(this.checkEventVaild(e,r,i)){switch(e){case"unlink":this._clearInternalCache(r,!0);break;case"unlinkDir":this._clearInternalCache(r,!1);break;case"add":this._updateInternalCache(r,i,!0);break;case"addDir":this._updateInternalCache(r,i,!1);break;case"change":{const h=this._cache.fileInfo[r];if(_.isWindows&&h&&h.mtimeMs===i.mtimeMs)return;if(this._changeEmptyFileMap[r]&&(clearTimeout(this._changeEmptyFileMap[r]),delete this._changeEmptyFileMap[r]),_.isWindows&&!this.canUseNewFW&&0===i.size)return this.logger.debug("darwin chang file detail size is 0",i),clearTimeout(this._changeEmptyFileMap[r]),void(this._changeEmptyFileMap[r]=setTimeout((()=>{delete this._changeEmptyFileMap[r],this.options.enableContentDiff&&this._cache.isFileContentChange(r,i)&&this.emit("all","contentChange",t,i,s),this._cache.fileInfo[r]=i,this.emit("all",e,t,i,s)}),50));this.options.enableContentDiff&&this._cache.isFileContentChange(r,i)&&this.emit("all","contentChange",t,i,s),i.isFile()&&(this._cache.fileInfo[r]=i);break}}this.emit("all",e,t,i,s)}},this.version=manifest.version,this.options=Object.assign({enableContentDiff:!1,enableNewFW:!0,enableDirCache:!0,enableNoEmit:!1,noCacheContent:!1,cacheStorePath:"",needReport:!1,ignore:[]},t),this.logger=logger_1.createLogger(`[Fileutils][${this.version}][#${this.id}]`),this.logger.warn(`new FileUtils instance dirpath = ${e}`,this.options),this.reporter=new reporter_1.Reporter(this.logger,{biz_id:2136,fileutilsVersion:this.version},this.options.needReport),this.dirPath=_.formatPath(e),this.enableCaseSensitive=void 0,this._changeEmptyFileMap={},this.ignoreRules=t.ignore||[],this.ignoreNocache=!!this.ignoreRules.length,this.runProcessTask=t.runProcessTask,this._cache=new cache_1.Cache(this.dirPath,{enableCaseSensitive:this.isSystemCaseSensitive()},this.logger),this.fileCacheUtils=new filecacheutils_1.FileCacheUtils(this.dirPath,t.cacheStorePath,this.logger),this.initParentWatch(),this.restart()}async restart(){this.reporter.timeStart("initAll"),this._cache.clean(),this.emit("start");const e=Date.now();Promise.all([this._getAllFile(),this._initWatch()]).then((()=>{this.emit("ready"),this.logger.warn("all ready",Date.now()-e),this._ready=!0,this.reporter.report({action:"initAll",actionDetail:`${this._info.getFileWay}-${this._info.fileWatcherType}`,result:0})})).catch((e=>{this.logger.error(e),this.reporter.report({action:"initAll",result:-1})}))}get canUseNewFW(){return this.options.enableNewFW&&fwhelper_1.canUseNewFileWatcher()}initParentWatch(){const e=path.basename(this.dirPath),t=path.dirname(this.dirPath);fse.pathExistsSync(t)&&(this._parentWatcher=fs.watch(t,{recursive:!1},((t,i)=>{"rename"===t&&i===e&&(this._reInitTimer&&clearTimeout(this._reInitTimer),this._reInitTimer=setTimeout((()=>{this.closeWatch(),this._cache.clean(),this._ready=!1,this.restart()}),1e3))})))}_deleteCache(){var e;null===(e=this.fileCacheUtils)||void 0===e||e.deleteCache(),this._cache.deleteAllFileData()}_initNewWatch(e){this._watcher=new FileWatcher(this.dirPath,{platform:process.platform,isDev:fwhelper_1.isDev,verbose:fwhelper_1.isDebug,logger:fwhelper_1.defaultLogger,nodePath:fwhelper_1.nodePath,msExePath:fwhelper_1.msExePath,chokidarJsPath:fwhelper_1.chokidarJsPath,externalWatcherProcess:this.runProcessTask},e),this._watcher.startWatch()}_initOldWatch(e){this._watcher=chokidar.watch(this.dirPath,e)}_initWatch(){return new Promise(((e,t)=>{const i=this.canUseNewFW?"initNewWatcher":"initOldWatcher";if(this._info.fileWatcherType=i,this.reporter.timeStart(i),!this.dirPath||!fse.pathExistsSync(this.dirPath))return this._ready=!0,this.reporter.report({action:i,result:config_1.ERROR_CODE_MAP.DIRPATH_NOT_EXIST,duration:0}),t();const s=config_1.DEFAULT_CHOKDAR_CONFIG.$ignoredSuffix.concat(this.ignoreRules).map((e=>path.join(this.dirPath,e).replace(/\\/g,"/").replace(/\/+/g,"/"))),r=Object.assign(Object.assign(Object.assign({},config_1.DEFAULT_CHOKDAR_CONFIG),{ignored:s}),this.options.chokidarConfig);this.ignoreMatcher=anymatch(s),this.closeWatch(),this.canUseNewFW?this._initNewWatch(r):this._initOldWatch(r),this._watcher.on("ready",(()=>{this.reporter.report({action:i,result:0}),this.emit("watchFileReady"),e(!0)})),this._watcher.on("all",this._all.bind(this))}))}_handleGlobResult(e,t,i){const s={folderInfo:{"./":{mtimeMs:fse.lstatSync(this.dirPath).mtimeMs,children:[]}},ignoreds:[]},r=[],h=[],a={};i.forEach((i=>{i=i.replace(/\\/g,path.posix.sep);const n=path.join(this.dirPath,i),o=fs.lstatSync(n);if(o.isFile()){if(r.push(i),h.push(i),a[i]=o,!e){const e=path.posix.dirname(i)+path.posix.sep;try{if(s.folderInfo[e])s.folderInfo[e].children.push(i);else{const t=path.posix.join(this.dirPath,e),r=fs.lstatSync(t);s.folderInfo[e]={mtimeMs:r.mtimeMs,children:[i]}}}catch(s){this.logger.error(`getAllFileByGlob errorPath: ${i} ${e} \n${t}\n`,s)}}}else h.push(i),e||(s.folderInfo[i]={mtimeMs:o.mtimeMs,children:[]})})),this._cache.fileList=r,this._cache.completeFileList=h,this._cache.fileInfo=a,this.options.enableDirCache||this._deleteCache(),e||(s.ignoreds=t,this.fileCacheUtils.writeCache(s))}_globSync(e){return new Promise(((t,i)=>{try{t(glob.sync("**",e))}catch(e){i(e.message)}}))}_globAsync(e){return new Promise(((t,i)=>{var s,r,h;const a=path.join(fwhelper_1.unpackPath,"globfile.js"),n=child_process.fork(a,["--expose-gc"],{execPath:fwhelper_1.nodePath,stdio:["pipe","pipe","pipe","ipc"],env:Object.assign({},process.env)});n.on("message",(e=>{setTimeout((()=>{n.kill()}),2e3),t(e)})),null===(s=n.stdout)||void 0===s||s.setEncoding("utf8"),null===(r=n.stdout)||void 0===r||r.on("data",(()=>{})),null===(h=n.stderr)||void 0===h||h.on("data",(e=>{this.logger.error(`stderr: ${e}`),i(e)})),n.send(e)}))}_getAllFileByGlob(e,t){return new Promise((i=>{const s=this.runProcessTask?"getFileByGlobAsync":"getFileByGlobSync";this._info.getFileWay=s;const r={nodir:!1,ignore:t,nosort:!0,strict:!1,silent:!0,cwd:this.dirPath,absolute:!1,mark:!0,dot:!0};this.reporter.timeStart(s);(this.runProcessTask?this._globAsync(r):this._globSync(r)).then((r=>{this.reporter.timeStart("handleGlobResult"),this._handleGlobResult(e,t,r),this.reporter.report({action:"handleGlobResult",result:0,duration:this.reporter.timeEnd(s)}),this.reporter.report({action:s,result:0}),i(!0)})).catch((e=>{this.logger.error(e),this.reporter.report({action:s,result:-1})}))}))}_getAllFileByDirCache(e,t){const i="getFileByDirCache";this._info.getFileWay=i;try{this.reporter.timeStart(i);const s=this.fileCacheUtils.getCompleteList(e,t);s&&(this.reporter.timeStart("initDriCacheResult"),this._cache.initAllFile(s),this.reporter.report({action:"initDriCacheResult",result:0}),this.reporter.report({action:i,result:1}))}catch(e){throw this.reporter.report({action:i,result:1}),this._deleteCache(),this._getAllFile(),e}}isSystemSupportCache(){let e=!1;if(!this.dirPath)return this.logger.error("System folder mtime check error: dirPath undefined"),e;const t=path.posix.dirname(this.dirPath),i=path.posix.join(t,"__systemSupport__");try{fse.ensureDirSync(t);const s=fse.lstatSync(t).mtimeMs;fse.ensureDirSync(i);const r=fse.lstatSync(t);e=r.mtimeMs!==s,this.logger.info(`System folder mtime check result: ${e}`)}catch(t){e=!1,this.logger.error("System folder mtime check error: ",t)}finally{fse.pathExistsSync(i)&&fse.removeSync(i)}return e}async _getAllFile(){try{const e="getFile";this.reporter.timeStart(e);const t=config_1.DEFAULT_FILE_IGNORE.concat(this.ignoreRules);let i=null;this.options.enableDirCache&&this.fileCacheUtils.isCacheExists()&&(i=this.fileCacheUtils.getCache(t),i||(this._deleteCache(),this.reporter.report({action:"getFileByDirCache",result:config_1.ERROR_CODE_MAP.DIRCACHE_IS_NULL})));const s=this.options.enableDirCache&&i&&this.isSystemSupportCache();if(!this.dirPath||!fse.pathExistsSync(this.dirPath))return this._deleteCache(),void this.reporter.report({action:e,result:config_1.ERROR_CODE_MAP.DIRPATH_NOT_EXIST});if(s?this._getAllFileByDirCache(i,t):await this._getAllFileByGlob(i,t),this._cache.initFileTransform(),this.options.enableContentDiff){const e="initAllFileContentMD5";this.reporter.timeStart(e),this._cache.initAllFileContentMD5(),this.reporter.report({action:e,result:0})}const r=this._cache.completeFileList.length;this.reporter.report({action:"projectFileNum",result:0,duration:r}),this.reporter.report({action:e,result:0})}finally{this.emit("allfilesupdate")}}checkEventVaild(e,t,i){const s=this._cache.isFileExist(t);return!("unlink"===e&&!s)&&(!("unlinkDir"===e&&!this._cache.isDirExist(t))&&(!this.options.enableNoEmit||!this._cache.isFileChange(t,i)))}formatWindowsSharePath(e,t=!0){return e=path.normalize(e).replace(/\\/g,"/"),t&&(e=path.posix.join(this.dirPath,e)),this.dirPath.startsWith("//")&&!e.startsWith("//")&&(e=`/${e}`),e}ready(e){this._ready?e():this.once("ready",(()=>{e()}))}closeWatch(){var e,t,i,s;null===(t=null===(e=this._watcher)||void 0===e?void 0:e.close)||void 0===t||t.call(e),null===(s=null===(i=this._watcher)||void 0===i?void 0:i.dispose)||void 0===s||s.call(i)}stopWatch(){var e;this.closeWatch(),this._cache.clean(),null===(e=this._parentWatcher)||void 0===e||e.close(),this._ready=!1,this.emit("close")}getAllFile(e){if(!e)return this._cache.fileList;const t=[];return this._cache.fileList.forEach((i=>{0===i.indexOf(e)&&t.push(path.posix.relative(e,i))})),t}getAllFileInfo(e){if(!e)return this._cache.fileInfo;const t={};for(const i in this._cache.fileInfo)0===i.indexOf(e)&&(t[path.posix.relative(e,i)]=this._cache.fileInfo[i]);return t}getAllFileWithDir(e){if(!e)return this._cache.completeFileList;const t=[];for(let i=0,s=this._cache.completeFileList.length;i<s;i++){const s=this._cache.completeFileList[i];if(0===s.indexOf(e)){let i=path.posix.relative(e,s);s.endsWith(path.posix.sep)&&!i.endsWith(path.posix.sep)&&(i+=path.posix.sep),t.push(i)}}return t}getFilesByExtName(e,t=""){if(!e)return this.getAllFile(t);const{fileList:i}=this._cache,s=[];return i.forEach((i=>{path.extname(i)===e&&0===i.indexOf(t)&&s.push(path.posix.relative(t,i))})),s}_transferPathToRealPath(e,t){if(e.indexOf("unlink")>-1)return t;if(this.isSystemCaseSensitive())return t;let i=path.posix.relative(this.dirPath,t);"addDir"===e&&(i=i.endsWith("/")?i:`${i}/`);if(i!==this._cache.getCacheRealPath(i)){const e=path.posix.dirname(t);let i=path.posix.basename(t);i=i.endsWith("/")?i.substring(0,i.length-1):i;const s=fse.readdirSync(e);for(let t=0,r=s.length;t<r;t++){const r=s[t];if(r.toLocaleLowerCase()===i.toLocaleLowerCase()){return path.posix.join(e,r)}}}return t}getFileInfo(e){if(path.isAbsolute(e))return null;e=this._cache.getCacheRealPath(e),e=this.formatWindowsSharePath(e,!1);const{fileInfo:t}=this._cache;let i=t[e];if(!i)try{const s=this.formatWindowsSharePath(e),r=fs.lstatSync(s);r.isFile()&&(i=t[e]=r)}catch(t){if(this._cache.completeFileList.length>0){const i=this._cache.completeFileList.indexOf(e)>-1;this.logger.error(`getFileInfoError, isFilePathInCompleteFileList: ${i} errorPath: ${e}, errorMsg: ${t.toString()}`)}else this.logger.error(`getFileInfoError, isFilePathInCompleteFileList: errorPath: ${e}, errorMsg: ${t.toString()}`);return null}return i}getFile(e,t="utf8",i=!1){if(path.isAbsolute(e))return;const s=t||"null";e=this.formatWindowsSharePath(e);const{fileData:r}=this._cache;if(r[e]||(r[e]={}),this.options.noCacheContent||i)return fs.readFileSync(e,t);if(this.ignoreNocache&&!r[e].checkIgnore){r[e].checkIgnore=!0;const t=e.replace(/\/+/g,"/");r[e].isIgnore=this.ignoreMatcher(t)}return r[e].isIgnore?fs.readFileSync(e,t):(r[e][s]||(r[e][s]=fs.readFileSync(e,t)),r[e][s])}async getFileAsync(e,t="utf8"){return new Promise(((i,s)=>{if(path.isAbsolute(e))return i(void 0);const r=null===t?"null":t;e=this.formatWindowsSharePath(e);const{fileData:h}=this._cache;if(h[e]||(h[e]={}),this.ignoreNocache&&!h[e].checkIgnore){h[e].checkIgnore=!0;const t=e.replace(/\/+/g,"/");h[e].isIgnore=this.ignoreMatcher(t)}this.options.noCacheContent||h[e].isIgnore||!h[e][r]?fs.readFile(e,t,((t,a)=>{if(t)return s(t);h[e]||(h[e]={}),h[e].isIgnore||(h[e][r]=a),i(a)})):i(h[e][r])}))}exists(e){return!!e&&(e=this.formatWindowsSharePath(e),fs.existsSync(e))}isDirectory(e){try{const t=this.formatWindowsSharePath(e);return fs.lstatSync(t).isDirectory()}catch(e){}return this._cache.isDirExist(e)}isFile(e){try{const t=this.formatWindowsSharePath(e);return fs.lstatSync(t).isFile()}catch(e){}return this._cache.isFileExist(e)}clearPathCache(e){try{e.forEach((e=>{const t=e;this.isFile(t)&&this._clearInternalCache(t,!0),this.isDirectory(t)&&this._clearInternalCache(t,!1)}))}catch(e){this.logger.error("clearPathCache error",e)}}isSystemCaseSensitive(){if(void 0!==this.enableCaseSensitive)return this.enableCaseSensitive;const e=this.options.cacheStorePath||"",t=fse.pathExistsSync(this.dirPath);if(t){const e=fse.pathExistsSync(this.dirPath.toLocaleLowerCase());this.enableCaseSensitive=e!==t}else{const t=fse.pathExistsSync(e);if(!t)return!1;const i=fse.pathExistsSync(e.toLocaleLowerCase());this.enableCaseSensitive=i!==t}return this.enableCaseSensitive}_clearInternalCache(e,t=!0){t||(e=e.endsWith("/")?e:`${e}/`);const i=this._cache.getCacheRealPath(e),s=this.formatWindowsSharePath(i);t?(this._cache.deleteFile(i,s),this._cache.clearFileTransFormCache(i,t)):(this._cache.deleteDir(i,s),this._cache.clearFileTransFormCache(e,t))}_updateInternalCache(e,t,i=!0){i||(e=e.endsWith("/")?e:`${e}/`);const s=this.isSystemCaseSensitive(),r=this._cache.getCacheRealPath(e),h=this.formatWindowsSharePath(r);r===e||s||(i&&this._cache.deleteFile(r,h),this._cache.clearFileTransFormCache(r,i)),i?(this._cache.fileData[h]&&delete this._cache.fileData[h],this._cache.fileInfo[e]=t,this._cache.addFile(e)):this._cache.addDir(e),this._cache.updateFileTransFormCache(e)}updatePathCache(e,t){try{e.forEach((e=>{const i=e,s=this.formatWindowsSharePath(e);let r=fs.lstatSync(s);const h=r.isFile(),a=r.isDirectory();if(h&&t&&t[e]){const i=t[e];i.mtimeMs>r.mtimeMs&&(r=i)}if(h&&this._updateInternalCache(i,r,!0),a){this._updateInternalCache(i,r,!1);fs.readdirSync(s).forEach((e=>{e&&(e=e.replace(/\\/g,"/")),e=path.posix.join(s,e);const t=path.posix.relative(this.dirPath,e),r=fs.lstatSync(e);r.isFile()&&this._updateInternalCache(t,r,!0),r.isDirectory()&&(this._updateInternalCache(i,r,!1),this.updatePathCache([t]))}))}}))}catch(e){this.logger.error("updatePathCache error",e)}}async writeFile(e,t,i="utf8"){if(!e)return;e=e.replace(/\\/g,"/");const s=this.formatWindowsSharePath(e),r=this.getAllUpdatePathsByFilePath(e);await fse.outputFile(s,t,i),this.updatePathCache(r)}writeFileSync(e,t,i="utf8"){if(!e)return;e=e.replace(/\\/g,"/");const s=this.formatWindowsSharePath(e),r=this.getAllUpdatePathsByFilePath(e),h=fse.outputFileSync(s,t,i);return this.updatePathCache(r),h}getAllUpdatePathsByFilePath(e){let t=[e];const i=e.split("/");i.pop();let s=!0;for(;s;){const e=this.formatWindowsSharePath(i.join("/")),r=fse.pathExistsSync(e);r||(t=[i.join("/")]),i.pop(),(r||0===i.length)&&(s=!1)}return t}outputFileSync(e,t,i="utf8"){return this.writeFileSync(e,t,i)}async outputFile(e,t,i="utf8"){return this.writeFile(e,t,i)}async ensureDir(e){if(!e)return;const t=this.formatWindowsSharePath(e),i=await fse.ensureDir(t);return this.updatePathCache([e]),i}async copyFile(e,t,i={}){if(!e||!t)return;const s=this.formatWindowsSharePath(e),r=this.formatWindowsSharePath(t),h=await fse.copy(s,r,i);return this.updatePathCache([t]),h}copyFileSync(e,t,i={}){if(!e||!t)return;const s=this.formatWindowsSharePath(e),r=this.formatWindowsSharePath(t),h=fse.copySync(s,r,i);return this.updatePathCache([t]),h}unlinkFile(e){return new Promise(((t,i)=>{if(!e)return;const s=this.formatWindowsSharePath(e);fs.unlink(s,(r=>{r?i(r):(this.clearPathCache([e]),this.emit("all","unlink",s,void 0,{}),t(!0))}))}))}unlinkFileSync(e){if(!e)return;const t=this.formatWindowsSharePath(e);fse.removeSync(t),this.clearPathCache([e]),this.emit("all","unlink",t,void 0,{})}removeSync(e){if(!e)return;const t=this.formatWindowsSharePath(e),i=this.getAllUnlinkFilePaths(e);fse.removeSync(t),this.clearPathCache([e]),this.emitUnlinkAndUnlinkDir(i)}async remove(e){if(!e)return;const t=this.formatWindowsSharePath(e),i=this.getAllUnlinkFilePaths(e);await fse.remove(t),this.clearPathCache([e]),this.emitUnlinkAndUnlinkDir(i)}emitUnlinkAndUnlinkDir(e){for(let t=0;t<e.length;t++){const i=e[t];i.endsWith(path.posix.sep)?this.emit("all","unlinkDir",i,void 0,{}):this.emit("all","unlink",i,void 0,{})}}getAllUnlinkFilePaths(e){const t=this.formatWindowsSharePath(e),i=[];if(this.isFile(e))i.push(t);else{const t=this.getAllFileWithDir(this.formatWindowsSharePath(e,!1)).map((t=>path.posix.join(e,t)));for(let e=0;e<t.length;e++)i.push(this.formatWindowsSharePath(t[e]))}return i}moveSync(e,t,i={}){if(!e||!t)return;const s=this.formatWindowsSharePath(e),r=this.formatWindowsSharePath(t);fse.moveSync(s,r,i),this.clearPathCache([e]),this.updatePathCache([t])}async move(e,t,i={}){if(!e||!t)return;const s=this.formatWindowsSharePath(e),r=this.formatWindowsSharePath(t);await fse.move(s,r,i),this.clearPathCache([e]),this.updatePathCache([t])}renameFileSync(e,t){if(!e||!t)return;const i=this.formatWindowsSharePath(e),s=this.formatWindowsSharePath(t),r=fs.renameSync(i,s);return this.clearPathCache([e]),this.updatePathCache([t]),r}}exports.FileUtils=FileUtils;